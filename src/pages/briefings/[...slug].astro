---
import { getCollection } from 'astro:content';
import Base from '../../layouts/Base.astro';
import TableOfContents from '../../components/TableOfContents.astro';
import ScrollToTop from '../../components/ScrollToTop.astro';

export async function getStaticPaths() {
  const briefings = await getCollection('briefings');
  return briefings.map((entry) => ({
    params: { slug: entry.slug },
    props: { entry }
  }));
}

const { entry } = Astro.props;
const { Content, headings } = await entry.render();

// Get all briefings for prev/next navigation
const allBriefings = (await getCollection('briefings'))
  .filter(b => !b.data.draft)
  .sort((a, b) => b.data.date.getTime() - a.data.date.getTime());

const currentIndex = allBriefings.findIndex(b => b.slug === entry.slug);
const prevBriefing = currentIndex < allBriefings.length - 1 ? allBriefings[currentIndex + 1] : null;
const nextBriefing = currentIndex > 0 ? allBriefings[currentIndex - 1] : null;

// Calculate reading time
const words = entry.body.split(/\s+/).length;
const readingTime = Math.ceil(words / 200);

const typeLabels: Record<string, string> = {
  weekly: 'Weekly Briefing',
  breaking: 'Breaking News',
  research: 'Research',
  digest: 'Digest'
};
---

<Base title={entry.data.title} description={entry.data.description} heroImage={entry.data.heroImage}>
  <article>
    <header>
      <div class="header-meta">
        <span class="tag">{typeLabels[entry.data.type] || entry.data.type}</span>
        <span class="reading-time">{readingTime} Min. Lesezeit</span>
      </div>
      <h1>{entry.data.title}</h1>
      <p class="meta">
        {entry.data.date.toLocaleDateString('de-DE', {
          weekday: 'long',
          year: 'numeric',
          month: 'long',
          day: 'numeric'
        })}
      </p>
      {entry.data.tags.length > 0 && (
        <div class="tags">
          {entry.data.tags.map((tag: string) => (
            <span class="tag">{tag}</span>
          ))}
        </div>
      )}
    </header>

    <TableOfContents headings={headings} />

    <div class="content">
      <Content />
    </div>

    {entry.data.sources && entry.data.sources.length > 0 && (
      <div class="sources">
        <h3>Quellen</h3>
        <div class="sources-grid">
          {entry.data.sources.map((source: { title: string; url: string }) => (
            <a href={source.url} target="_blank" rel="noopener" class="source-card">
              <span class="source-title">{source.title}</span>
              <span class="source-domain">{new URL(source.url).hostname.replace('www.', '')}</span>
            </a>
          ))}
        </div>
      </div>
    )}

    <nav class="briefing-nav">
      {prevBriefing && (
        <a href={`/bks-news/briefings/${prevBriefing.slug}/`} class="nav-prev">
          <span class="nav-label">&larr; Vorher</span>
          <span class="nav-title">{prevBriefing.data.title}</span>
        </a>
      )}
      {nextBriefing && (
        <a href={`/bks-news/briefings/${nextBriefing.slug}/`} class="nav-next">
          <span class="nav-label">Neuer &rarr;</span>
          <span class="nav-title">{nextBriefing.data.title}</span>
        </a>
      )}
    </nav>
  </article>

  <ScrollToTop />

  <script>
    // Transform TL;DR section with JavaScript for reliable styling
    document.addEventListener('DOMContentLoaded', () => {
      const content = document.querySelector('.content');
      if (!content) return;

      const firstH2 = content.querySelector('h2');
      if (firstH2 && firstH2.textContent?.trim().toUpperCase() === 'TL;DR') {
        // Create styled TL;DR badge
        const badge = document.createElement('div');
        badge.className = 'tldr-badge';
        badge.textContent = 'TL;DR';

        // Create wrapper for the entire TL;DR section
        const wrapper = document.createElement('div');
        wrapper.className = 'tldr-section';

        // Find the intro text and bullet list
        let nextEl = firstH2.nextElementSibling;
        const elementsToWrap: Element[] = [];

        while (nextEl && nextEl.tagName !== 'H2' && nextEl.tagName !== 'HR') {
          elementsToWrap.push(nextEl);
          nextEl = nextEl.nextElementSibling;
        }

        // Build the wrapper
        wrapper.appendChild(badge);
        elementsToWrap.forEach(el => wrapper.appendChild(el.cloneNode(true)));

        // Replace original elements
        firstH2.replaceWith(wrapper);
        elementsToWrap.forEach(el => el.remove());
      }
    });
  </script>
</Base>

<style>
  article header {
    margin-bottom: 2rem;
  }

  .header-meta {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1rem;
  }

  .reading-time {
    color: var(--color-muted);
    font-size: 0.85rem;
  }

  .tags {
    margin-top: 1rem;
  }

  .content {
    font-size: 1.05rem;
  }

  /* TL;DR Section Styling - Class-based for reliability */
  .content :global(.tldr-section) {
    background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(37, 99, 235, 0.05) 100%);
    border: 1px solid var(--color-accent);
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 2rem;
  }

  [data-theme="light"] .content :global(.tldr-section) {
    background: linear-gradient(135deg, rgba(59, 130, 246, 0.08) 0%, rgba(37, 99, 235, 0.03) 100%);
  }

  .content :global(.tldr-badge) {
    display: inline-block;
    background: var(--color-accent);
    color: white;
    font-size: 0.7rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    padding: 0.35rem 0.7rem;
    border-radius: 4px;
    margin-bottom: 1rem;
  }

  .content :global(.tldr-section p) {
    color: var(--color-muted);
    font-size: 0.9rem;
    margin-bottom: 0.75rem;
  }

  .content :global(.tldr-section ul) {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .content :global(.tldr-section li) {
    padding: 0.6rem 0;
    border-bottom: 1px solid rgba(59, 130, 246, 0.2);
    margin: 0;
  }

  .content :global(.tldr-section li:last-child) {
    border-bottom: none;
    padding-bottom: 0;
  }

  /* Sources Grid */
  .sources {
    margin-top: 3rem;
    padding-top: 2rem;
    border-top: 1px solid var(--color-border);
  }

  .sources h3 {
    color: var(--color-muted);
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: 1rem;
  }

  .sources-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 1rem;
  }

  .source-card {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
    padding: 1rem;
    background: var(--color-card-bg);
    border: 1px solid var(--color-border);
    border-radius: 8px;
    text-decoration: none;
    transition: border-color 0.2s, transform 0.2s;
  }

  .source-card:hover {
    border-color: var(--color-accent);
    transform: translateY(-2px);
    text-decoration: none;
  }

  .source-title {
    color: var(--color-text);
    font-size: 0.95rem;
    line-height: 1.4;
  }

  .source-domain {
    color: var(--color-muted);
    font-size: 0.8rem;
  }

  /* Prev/Next Navigation */
  .briefing-nav {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
    margin-top: 3rem;
    padding-top: 2rem;
    border-top: 1px solid var(--color-border);
  }

  .nav-prev, .nav-next {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
    padding: 1rem;
    background: var(--color-card-bg);
    border: 1px solid var(--color-border);
    border-radius: 8px;
    text-decoration: none;
    transition: border-color 0.2s;
  }

  .nav-prev:hover, .nav-next:hover {
    border-color: var(--color-accent);
    text-decoration: none;
  }

  .nav-next {
    text-align: right;
  }

  .nav-label {
    color: var(--color-muted);
    font-size: 0.8rem;
  }

  .nav-title {
    color: var(--color-text);
    font-size: 0.95rem;
    font-weight: 500;
  }

  @media (max-width: 600px) {
    .briefing-nav {
      grid-template-columns: 1fr;
    }
  }
</style>
