---
import { getCollection } from 'astro:content';
import Base from '../../../layouts/Base.astro';
import TableOfContents from '../../../components/TableOfContents.astro';
import ScrollToTop from '../../../components/ScrollToTop.astro';
import TagLink from '../../../components/TagLink.astro';
import RelatedArticles from '../../../components/RelatedArticles.astro';
import SourceCard from '../../../components/SourceCard.astro';
import { t } from '../../../i18n/translations';

const lang = 'en';

export async function getStaticPaths() {
  const briefings = await getCollection('briefings-en');
  return briefings.map((entry) => ({
    params: { slug: entry.slug },
    props: { entry }
  }));
}

const { entry } = Astro.props;
const { Content, headings } = await entry.render();

// Get all briefings for prev/next navigation
const allBriefings = (await getCollection('briefings-en'))
  .filter(b => !b.data.draft)
  .sort((a, b) => b.data.date.getTime() - a.data.date.getTime());

const currentIndex = allBriefings.findIndex(b => b.slug === entry.slug);
const prevBriefing = currentIndex < allBriefings.length - 1 ? allBriefings[currentIndex + 1] : null;
const nextBriefing = currentIndex > 0 ? allBriefings[currentIndex - 1] : null;

// Calculate reading time
const words = entry.body.split(/\s+/).length;
const readingTime = Math.ceil(words / 200);

const typeLabels: Record<string, string> = {
  weekly: t('type.weekly', lang),
  breaking: t('type.breaking', lang),
  research: t('type.research', lang),
  digest: t('type.digest', lang)
};

// Hero-Image: AI-generiert via Pollinations.ai (generate-hero.sh)
const heroUrl = entry.data.heroImage || null;
const heroAlt = entry.data.heroImageAlt || entry.data.title;
---

<Base title={entry.data.title} description={entry.data.description} heroImage={heroUrl || undefined} lang={lang}>
  <article>
    {heroUrl && (
      <img
        src={heroUrl}
        alt={heroAlt}
        class="hero-image"
        loading="lazy"
      />
    )}
    <header>
      <div class="header-meta">
        <span class={`type-badge type-${entry.data.type}`}>{typeLabels[entry.data.type] || entry.data.type}</span>
        <span class="reading-time">{readingTime} {t('article.readingTime', lang)}</span>
      </div>
      <h1>{entry.data.title}</h1>
      <p class="meta">
        {entry.data.date.toLocaleDateString('en-US', {
          weekday: 'long',
          year: 'numeric',
          month: 'long',
          day: 'numeric'
        })}
      </p>
      {entry.data.tags.length > 0 && (
        <div class="tags">
          {entry.data.tags.map((tag: string) => (
            <TagLink tag={tag} basePath="/bks-news/en/tags" />
          ))}
        </div>
      )}
      <div class="ai-disclosure">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M12 8V4H8"/>
          <rect width="16" height="12" x="4" y="8" rx="2"/>
          <path d="M2 14h2"/>
          <path d="M20 14h2"/>
          <path d="M15 13v2"/>
          <path d="M9 13v2"/>
        </svg>
        <span>{t('article.aiDisclosure', lang)}</span>
      </div>
    </header>

    <TableOfContents headings={headings} label={t('toc.title', lang)} />

    <div class="content">
      <Content />
    </div>

    {entry.data.sources && entry.data.sources.length > 0 && (
      <div class="sources">
        <h3>{t('article.sources', lang)}</h3>
        <p class="sources-intro">{entry.data.sources.length} sources from verified news outlets and official company blogs.</p>
        <div class="sources-grid">
          {entry.data.sources.map((source: { title: string; url: string }) => (
            <SourceCard title={source.title} url={source.url} lang="en" />
          ))}
        </div>
      </div>
    )}

    <RelatedArticles
      currentSlug={entry.slug}
      currentTags={entry.data.tags}
      allBriefings={allBriefings}
      basePath="/bks-news/en/briefings"
      lang={lang}
    />

    <nav class="briefing-nav">
      {prevBriefing && (
        <a href={`/bks-news/en/briefings/${prevBriefing.slug}/`} class="nav-prev">
          <span class="nav-label">&larr; {t('article.prevArticle', lang)}</span>
          <span class="nav-title">{prevBriefing.data.title}</span>
        </a>
      )}
      {nextBriefing && (
        <a href={`/bks-news/en/briefings/${nextBriefing.slug}/`} class="nav-next">
          <span class="nav-label">{t('article.nextArticle', lang)} &rarr;</span>
          <span class="nav-title">{nextBriefing.data.title}</span>
        </a>
      )}
    </nav>
  </article>

  <ScrollToTop />

</Base>

<style>
  /* Hero Image */
  .hero-image {
    width: 100%;
    height: auto;
    max-height: 400px;
    object-fit: cover;
    border-radius: 12px;
    margin-bottom: 2rem;
  }

  article header {
    margin-bottom: 2rem;
  }

  .header-meta {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1rem;
  }

  /* Dezente Type-Badges */
  .type-badge {
    display: inline-block;
    font-size: 0.75rem;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
  }

  .type-weekly {
    background: rgba(102, 126, 234, 0.15);
    color: #667eea;
  }

  .type-breaking {
    background: rgba(239, 68, 68, 0.15);
    color: #ef4444;
  }

  .type-research {
    background: rgba(16, 185, 129, 0.15);
    color: #10b981;
  }

  .type-digest {
    background: rgba(245, 158, 11, 0.15);
    color: #f59e0b;
  }

  .reading-time {
    color: var(--color-muted);
    font-size: 0.85rem;
  }

  .tags {
    margin-top: 1rem;
  }

  .ai-disclosure {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    margin-top: 1rem;
    padding: 0.5rem 0.75rem;
    background: var(--color-card-bg);
    border: 1px solid var(--color-border);
    border-radius: 6px;
    font-size: 0.85rem;
    color: var(--color-muted);
  }

  .ai-disclosure svg {
    flex-shrink: 0;
    opacity: 0.7;
  }

  .content {
    font-size: 1.05rem;
  }

  /* Sources Grid */
  .sources {
    margin-top: 3rem;
    padding-top: 2rem;
    border-top: 1px solid var(--color-border);
  }

  .sources h3 {
    color: var(--color-muted);
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: 0.5rem;
  }

  .sources-intro {
    color: var(--color-muted);
    font-size: 0.85rem;
    margin-bottom: 1.25rem;
  }

  .sources-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 1rem;
  }

  /* Prev/Next Navigation */
  .briefing-nav {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
    margin-top: 3rem;
    padding-top: 2rem;
    border-top: 1px solid var(--color-border);
  }

  .nav-prev, .nav-next {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
    padding: 1rem;
    background: var(--color-card-bg);
    border: 1px solid var(--color-border);
    border-radius: 8px;
    text-decoration: none;
    transition: border-color 0.2s;
  }

  .nav-prev:hover, .nav-next:hover {
    border-color: var(--color-accent);
    text-decoration: none;
  }

  .nav-next {
    text-align: right;
  }

  .nav-label {
    color: var(--color-muted);
    font-size: 0.8rem;
  }

  .nav-title {
    color: var(--color-text);
    font-size: 0.95rem;
    font-weight: 500;
  }

  @media (max-width: 600px) {
    .briefing-nav {
      grid-template-columns: 1fr;
    }
  }
</style>
