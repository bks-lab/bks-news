---
import type { CollectionEntry } from 'astro:content';
import TagLink from './TagLink.astro';

interface Props {
  currentSlug: string;
  currentTags: string[];
  allBriefings: CollectionEntry<'briefings'>[];
  limit?: number;
}

const { currentSlug, currentTags, allBriefings, limit = 3 } = Astro.props;

// Find related articles based on shared tags
const relatedArticles = allBriefings
  .filter(b => b.slug !== currentSlug && !b.data.draft)
  .map(briefing => {
    // Count shared tags
    const sharedTags = briefing.data.tags.filter(tag =>
      currentTags.some(ct => ct.toLowerCase() === tag.toLowerCase())
    );
    return {
      briefing,
      sharedTags,
      sharedCount: sharedTags.length
    };
  })
  .filter(item => item.sharedCount > 0)
  .sort((a, b) => {
    // Sort by shared tag count, then by date
    if (b.sharedCount !== a.sharedCount) {
      return b.sharedCount - a.sharedCount;
    }
    return b.briefing.data.date.valueOf() - a.briefing.data.date.valueOf();
  })
  .slice(0, limit);

const typeLabels: Record<string, string> = {
  weekly: 'Weekly',
  breaking: 'Breaking',
  research: 'Research',
  digest: 'Digest'
};
---

{relatedArticles.length > 0 && (
  <aside class="related-articles">
    <h3>Verwandte Artikel</h3>
    <ul>
      {relatedArticles.map(({ briefing, sharedTags }) => (
        <li>
          <a href={`/bks-news/briefings/${briefing.slug}/`} class="related-link">
            <span class="related-meta">
              <span class="date">{briefing.data.date.toLocaleDateString('de-DE')}</span>
              <span class="type">{typeLabels[briefing.data.type] || briefing.data.type}</span>
            </span>
            <span class="related-title">{briefing.data.title}</span>
          </a>
          <div class="shared-tags">
            {sharedTags.map((tag: string) => (
              <TagLink tag={tag} size="sm" />
            ))}
          </div>
        </li>
      ))}
    </ul>
  </aside>
)}

<style>
  .related-articles {
    margin-top: 3rem;
    padding-top: 2rem;
    border-top: 1px solid var(--color-border);
  }

  .related-articles h3 {
    color: var(--color-muted);
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: 1.5rem;
  }

  .related-articles ul {
    list-style: none;
    padding: 0;
    margin: 0;
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .related-articles li {
    padding: 1rem;
    background: var(--color-card-bg);
    border: 1px solid var(--color-border);
    border-radius: 8px;
    transition: border-color 0.2s;
  }

  .related-articles li:hover {
    border-color: var(--color-accent);
  }

  .related-link {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
    text-decoration: none;
    margin-bottom: 0.5rem;
  }

  .related-link:hover {
    text-decoration: none;
  }

  .related-meta {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-size: 0.8rem;
  }

  .date {
    color: var(--color-muted);
  }

  .type {
    color: var(--color-muted);
    background: var(--color-border);
    padding: 0.1rem 0.4rem;
    border-radius: 3px;
    font-size: 0.75rem;
  }

  .related-title {
    color: var(--color-text);
    font-weight: 500;
    font-size: 0.95rem;
  }

  .related-link:hover .related-title {
    color: var(--color-accent);
  }

  .shared-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 0.35rem;
  }
</style>
